-- Запросы для индивидуального задания

-- Запрос возвращает информацию о клиентах и суммарной стоимости сделок, в которых они участвуют
SELECT -- Выбирает данные из таблиц
    к.ФИО AS ФИО_клиента,
    к.Контактная_информация,
    SUM(с.Цена_квартиры) AS Суммарная_стоимость_сделок -- Суммирует стоимость всех сделок для каждого клиента
FROM Клиенты к
JOIN Сделки_Клиенты ск ON к.ID_клиента = ск.ID_клиента -- Соединяет таблицы "Клиенты", "Сделки_Клиенты" и "Сделки"
JOIN Сделки с ON ск.ID_сделки = с.ID_сделки
GROUP BY к.ID_клиента, к.ФИО, к.Контактная_информация -- Группирует данные по каждому клиенту, чтобы вычислить их сумму сделок
ORDER BY Суммарная_стоимость_сделок DESC; -- Сортирует клиентов по убыванию суммарной стоимости сделок

-- Запрос добавляет расчет средней стоимости сделок для каждого клиента
SELECT -- Выбирает данные из таблиц
    к.ФИО AS ФИО_клиента,
    к.Контактная_информация,
    SUM(с.Цена_квартиры) AS Суммарная_стоимость_сделок, -- Суммирует стоимость всех сделок для каждого клиента
    AVG(с.Цена_квартиры) AS Средняя_стоимость_сделки -- Вычисляет среднюю стоимость сделок клиента
FROM Клиенты к
JOIN Сделки_Клиенты ск ON к.ID_клиента = ск.ID_клиента -- Соединяет таблицы "Клиенты", "Сделки_Клиенты" и "Сделки"
JOIN Сделки с ON ск.ID_сделки = с.ID_сделки
GROUP BY к.ID_клиента, к.ФИО, к.Контактная_информация -- Группирует данные по каждому клиенту, чтобы вычислить их сумму сделок
ORDER BY Суммарная_стоимость_сделок DESC; -- Сортирует клиентов по убыванию суммарной стоимости сделок

-- Запрос, который находит клиентов с максимальной суммарной стоимостью сделок
WITH ClientTotals AS ( -- Создает временную таблицу ClientTotals с суммарной стоимостью сделок для каждого клиента
    SELECT 
        к.ID_клиента,
        к.ФИО AS ФИО_клиента,
        SUM(с.Цена_квартиры) AS Суммарная_стоимость_сделок -- Суммирует стоимость всех сделок для каждого клиента
    FROM Клиенты к
    JOIN Сделки_Клиенты ск ON к.ID_клиента = ск.ID_клиента -- Соединяет таблицы "Клиенты", "Сделки_Клиенты" и "Сделки"
    JOIN Сделки с ON ск.ID_сделки = с.ID_сделки
    GROUP BY к.ID_клиента, к.ФИО -- Группирует данные по каждому клиенту, чтобы вычислить их сумму сделок
)
SELECT ФИО_клиента, Суммарная_стоимость_сделок
FROM ClientTotals
WHERE Суммарная_стоимость_сделок = (SELECT MAX(Суммарная_стоимость_сделок) FROM ClientTotals); -- MAX: Определяет максимальную суммарную стоимость среди всех клиентов и WHERE: Фильтрует клиента с максимальной суммой сделок

-- Запрос, который возвращает список сделок клиента с максимальной суммой
WITH ClientTotals AS ( -- ClientTotals для подсчета сумм сделок клиентов
    SELECT 
        к.ID_клиента,
        SUM(с.Цена_квартиры) AS Суммарная_стоимость_сделок
    FROM Клиенты к
    JOIN Сделки_Клиенты ск ON к.ID_клиента = ск.ID_клиента -- Соединяет таблицы "Клиенты", "Сделки_Клиенты" и "Сделки"
    JOIN Сделки с ON ск.ID_сделки = с.ID_сделки
    GROUP BY к.ID_клиента -- Группирует данные по каждому клиенту
),
MaxClient AS ( -- MaxClient для выбора клиента с максимальной суммой
    SELECT ID_клиента
    FROM ClientTotals
    WHERE Суммарная_стоимость_сделок = (SELECT MAX(Суммарная_стоимость_сделок) FROM ClientTotals) -- MAX: Определяет максимальную суммарную стоимость среди всех клиентов и WHERE: Фильтрует клиента с максимальной суммой сделок
)
SELECT 
    с.ID_сделки AS Номер_сделки,
    с.Цена_квартиры AS Стоимость_квартиры
FROM Сделки с
JOIN Сделки_Клиенты ск ON с.ID_сделки = ск.ID_сделки
WHERE ск.ID_клиента IN (SELECT ID_клиента FROM MaxClient)
ORDER BY с.Цена_квартиры ASC; -- Сортирует сделки клиента по возрастанию стоимости

-- Запрос вычисляет суммарные комиссионные для каждого риэлтора
SELECT -- Выбирает данные из таблиц
    р.ФИО AS ФИО_риэлтора,
    SUM(с.Цена_квартиры * (р.Процент_вознаграждения / 100)) AS Суммарные_комиссионные -- Суммирует комиссионные риэлтора, рассчитанные как "Цена квартиры * Процент вознаграждения / 100"
FROM Риэлторы р
JOIN Сделки с ON р.ID_риэлтора = с.ID_риэлтора
GROUP BY р.ID_риэлтора, р.ФИО -- Группирует данные по риэлторам
ORDER BY Суммарные_комиссионные DESC; -- Сортирует риэлторов по убыванию комиссионных
